{% extends "LavasecoBundle:BootsTrap:Base/base.html.twig" %}

{% block stylesheets %}
    <link rel="stylesheet" type="text/css" href="{{ asset("BootsTrapTheme/css/timeline.css") }}">
    <link rel="stylesheet" type="text/css" href="{{ asset("BootsTrapTheme/css/jquery.dataTables.css") }}">
{% endblock %} 

{% block body %} 
    <h3 >Facturas</h3>
    <p>
        En esta pagina puedes ver las facturas su estado y la trazabilidad del proceso.
    </p>
    <hr>
    <div class="row">
        <!--facturas-->
        <div class="col-md-12">
            <div class="collapse" id="collapseProcessline">
                <h5 id="titleLineTime"></h5>
                <div style="display:inline-block;width:100%;overflow-y:auto;">
                    <ul  id="listLineTime" class="timeline timeline-horizontal">
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <!--facturas-->
        <div class="col-md-12"> 
            <div class="well well-sm pull-right">
                <form class="form-inline">
                    <button type="button" id="changeStateButton" class="btn btn-default" onclick="changeEstate();">Cobrar</button>
                    |
                    <div class="form-group">
                        <select class="form-control" id="sel1">
                            <option>Seleccione un estado </option>
                        </select>
                    </div>
                </form>                
            </div>

            <table id="billsTable" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Factura</th>
                        <th>Cliente</th>
                        <th>Telefono</th>
                        <th>Estado Proceso</th>
                        <th>Pago</th>
                        <th>Estado Factura</th>
                        <th>observaci√≥n</th>
                        <th>Vendedor</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill in bills %}
                        <tr>
                            <td>{{ bill.id }}</td>
                            <td>{{ bill.customerUser.name | default("No se Registro Cliente")}}</td>
                            <td>{{ bill.customerUser.phoneNumber | default("No se Registro Cliente")}}</td>
                            <td>{{ bill.processState.name}}</td>
                            <td>{{ bill.paymentAgreement.name }}</td>
                            <td>{{ bill.billState.name}}</td>
                            <td>{{ bill.observation}}</td>
                            <td>{{ bill.sellerUser.name }}</td>
                            <td>{{ bill.CreatedAtString}}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    <script type="text/javascript" src="{{ asset("BootsTrapTheme/js/jquery.number.min.js") }}"></script>
    <script type="text/javascript" charset="utf8" src="{{ asset("BootsTrapTheme/js/jquery.dataTables.js") }}"></script>

    <script>
        $(document).ready(function () {
            var billsTable = $('#billsTable').DataTable({
                "order": [[0, "Desc"]]
            });

            $('#billsTable tbody').on('click', 'tr', function () {
                var data = billsTable.row(this).data();

                $(".selected").toggleClass('selected');

                $(this).toggleClass('selected');

                collapseProcessLine(data[0]);
            });
        });

        function collapseProcessLine(billId) {

            $.ajax({
                url: "{{ path('lavaseco_api_bill_history') }}/" + billId,
                method: "GET",
                contentType: 'application/json',
                dataType: 'json',
                success: function (billHistories) {

                    $("#listLineTime").empty();
                    $("#titleLineTime").html("Factura: " + billHistories.bill + ", orden: " + billHistories.order);
                    for (var i in billHistories.histories) {
                        addProcesHistory(billHistories.histories[i]);
                    }

                    $('#collapseProcessline').collapse();
                    window.scrollTo(0, 0);
                }
            });
        }
        function addProcesHistory(billHistory) {
            var html = "<li class=\"timeline-item\">\
                            <div class=\"timeline-badge\"><i class=\"fa fa-check\" aria-hidden=\"true\"></i></div>\
                            <div class=\"timeline-panel\">\
                                <div class=\"timeline-heading\">\
                                    <h4 class=\"timeline-title\">" + billHistory.processState + "</h4>\
                                    <p><small class=\"text-muted\"><i class=\"glyphicon glyphicon-time\"></i> Fecha: " + billHistory.createdAt + "</small></p>\
                                    <p><small class=\"text-muted\"><i class=\"fa fa-user-o\" aria-hidden=\"true\"></i></i> Usuario: " + billHistory.user + "</small></p>\
                                </div>\
                                <div class=\"timeline-body\">\
                                    <p>" + billHistory.observation + "</p>\
                                </div>\
                            </div>\
                        </li>";
            $("#listLineTime").append(html);
        }
    </script>
{% endblock %}